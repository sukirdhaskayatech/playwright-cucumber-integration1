image: node:20

pipelines:
  custom:
    xray-run-tests:
      - step:
          name: Run Playwright + Cucumber + Upload to Xray
          caches:
            - node
          script:
            - echo "Installing dependencies"
            - npm install
            - npx playwright install

            - echo "Running Cucumber tests"
            - npx cucumber-js --format json:reports/cucumber.json

            - echo "Authenticating to Xray"
            - TOKEN=$(curl -s -X POST \
                -H "Content-Type: application/json" \
                -d "{\"client_id\": \"${XRAY_CLIENT_ID}\", \"client_secret\": \"${XRAY_CLIENT_SECRET}\"}" \
                https://xray.cloud.getxray.app/api/v1/authenticate | tr -d '"')

            - echo "Uploading cucumber.json to Xray"
            - curl -H "Authorization: Bearer $TOKEN" \
                   -F "file=@reports/cucumber.json" \
                   https://xray.cloud.getxray.app/api/v2/import/execution/cucumber
